<script>
(() => {
  const canvas = document.getElementById('turtleCanvas');
  const ctx = canvas.getContext('2d');
  const W = 800, H = 600;

  function resizeCanvas() {
    const rect = canvas.getBoundingClientRect();
    canvas.width = W; canvas.height = H;
    canvas.style.width = rect.width+'px'; canvas.style.height = rect.height+'px';
  }
  window.addEventListener('resize', resizeCanvas); resizeCanvas();

  const $ = id=>document.getElementById(id);

  const State = {
    x:400,y:300,heading:0,speed:5,is_pen_down:true,pen_color:'white',pen_size:4,
    paths:[],polygons:[],text_elements:[],bg_color:'black',fill_color:'white',
    is_filling:false,fill_points:[],text_input_visible:false,
    snap_lock:false,pressed_keys:new Set(),show_mobile_prompt:false,is_mobile:false,
    COLOR_CYCLE:['white','red','blue','green','yellow','orange','purple','cyan','magenta','lime','pink','teal'],
    BG_COLOR_CYCLE:['black','darkslateblue','darkgreen','maroon','indigo','saddlebrown','#333333'],
    SPEED_CYCLE:[5,10,25,50,75,100]
  };

  let typingText = false; // freeze movement while typing

  function updateStatus(){
    $('penStatus').textContent = State.is_pen_down?'DOWN':'UP';
    $('penColor').textContent = State.pen_color;
    $('fillStatus').textContent = State.is_filling?'ON':'OFF';
    $('fillColor').textContent = State.fill_color;
    $('speed').textContent = State.speed;
    $('snapLock').textContent = State.snap_lock?'ON':'OFF';
  }

  function rad(deg){return deg*Math.PI/180;}
  function moveForward(record=true){
    const r=rad(State.heading),newX=State.x+State.speed*Math.cos(r),newY=State.y-State.speed*Math.sin(r);
    if(State.is_pen_down&&record){State.paths.push({start:{x:State.x,y:State.y},end:{x:newX,y:newY},color:State.pen_color,size:State.pen_size});}
    if(State.is_filling) State.fill_points.push({x:State.x,y:State.y});
    State.x=newX; State.y=newY;
  }
  function moveBackward(record=true){
    const r=rad(State.heading),newX=State.x-State.speed*Math.cos(r),newY=State.y+State.speed*Math.sin(r);
    if(State.is_pen_down&&record){State.paths.push({start:{x:State.x,y:State.y},end:{x:newX,y:newY},color:State.pen_color,size:State.pen_size});}
    if(State.is_filling) State.fill_points.push({x:State.x,y:State.y});
    State.x=newX; State.y=newY;
  }
  function turnLeft(){State.heading=(State.snap_lock?State.heading+45:State.heading+15)%360;}
  function turnRight(){State.heading=(State.snap_lock?State.heading-45+360:State.heading-15+360)%360;}

  function cycle(array,current){const i=array.indexOf(current); return array[(i+1)%array.length];}

  function handleKeyDown(e){
    // Allow typing inside input
    if(typingText) return;

    const key=e.key.toLowerCase();
    if([' ','arrowup','arrowdown','arrowleft','arrowright','backspace'].includes(key)) 
      e.preventDefault();

    State.pressed_keys.add(key);

    if(key===' '){
      State.is_pen_down=!State.is_pen_down;
    }
    else if(key==='c'){
      State.pen_color=cycle(State.COLOR_CYCLE,State.pen_color);
    }
    else if(key==='b'){
      State.bg_color=cycle(State.BG_COLOR_CYCLE,State.bg_color);
    }
    else if(key==='v'){
      State.fill_color=cycle(State.COLOR_CYCLE,State.fill_color);
    }
    else if(key==='f'){
      State.is_filling=!State.is_filling;
      if(State.is_filling){
        State.fill_points=[{x:State.x,y:State.y}];
      } else {
        if(State.fill_points.length>0){
          State.polygons.push({points:State.fill_points.slice(),color:State.fill_color});
          State.fill_points=[];
        }
      }
    }
    else if(key==='z'){
      if(State.paths.length>0) State.paths.pop();
    }
    else if(key==='r'){
      State.x=400;State.y=300;State.heading=0;
    }
    else if(key==='backspace'){
      State.paths=[];State.polygons=[];State.text_elements=[];
      State.x=400;State.y=300;State.heading=0;State.bg_color='black';
    }
    else if(key==='t'){
      e.preventDefault();   // FIX: Prevent "t" from typing in the input
      showTextInput();
      return;
    }
    else if(key==='k'){
      for(let side=0;side<4;side++){
        for(let step=0;step<4;step++) moveForward(true);
        State.heading=(State.heading-90+360)%360;
      }
    }
    else if(key==='m'){
      const idx=State.SPEED_CYCLE.indexOf(State.speed);
      State.speed=State.SPEED_CYCLE[(idx+1)%State.SPEED_CYCLE.length];
    }
    else if(key==='n'){
      State.snap_lock=!State.snap_lock;
    }
  
    updateStatus();
  }

  function handleKeyUp(e){
    if(typingText) return;
    State.pressed_keys.delete(e.key.toLowerCase());
  }

  window.addEventListener('keydown', handleKeyDown);
  window.addEventListener('keyup', handleKeyUp);

  const textOverlay=$('textOverlay'),
        textField=$('textField'),
        drawTextBtn=$('drawTextBtn'),
        cancelTextBtn=$('cancelTextBtn');

  function showTextInput(){
    textOverlay.style.display='flex';
    textField.value='';
    textField.focus();
    State.text_input_visible=true;
    typingText=true;
  }
  function hideTextInput(){
    textOverlay.style.display='none';
    State.text_input_visible=false;
    typingText=false;
  }

  drawTextBtn.addEventListener('click',()=>{
    const txt=textField.value.trim();
    if(txt.length>0)
      State.text_elements.push({content:txt,x:State.x,y:State.y,color:State.pen_color});
    hideTextInput();
  });

  cancelTextBtn.addEventListener('click',hideTextInput);

  // FIX: Backspace now works normally inside input
  textField.addEventListener('keydown',(e)=>{
    if(e.key==='Enter'){
      drawTextBtn.click();
      e.preventDefault();
    } else if(e.key==='Escape'){
      hideTextInput();
      e.preventDefault();
    }
  });


  setInterval(()=>{
    if(State.pressed_keys.size===0) return;
    if(State.pressed_keys.has('w')) moveForward(true);
    if(State.pressed_keys.has('s')) moveBackward(true);
    if(State.pressed_keys.has('a')) turnLeft();
    if(State.pressed_keys.has('d')) turnRight();
    if(State.pressed_keys.has('z') && State.paths.length>0) State.paths.pop();
    updateStatus();
  },50);

  function draw(){
    ctx.save(); ctx.fillStyle=State.bg_color; ctx.fillRect(0,0,W,H);

    for(const poly of State.polygons){
      const pts=poly.points;
      if(pts&&pts.length>0){
        ctx.beginPath();
        ctx.moveTo(pts[0].x,pts[0].y);
        for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x,pts[i].y);
        ctx.closePath();
        ctx.fillStyle=poly.color;
        ctx.fill();
      }
    }

    if(State.is_filling&&State.fill_points.length>0){
      ctx.beginPath();
      ctx.moveTo(State.fill_points[0].x,State.fill_points[0].y);
      for(let i=1;i<State.fill_points.length;i++) ctx.lineTo(State.fill_points[i].x,State.fill_points[i].y);
      ctx.lineWidth=1;
      ctx.strokeStyle=State.fill_color;
      ctx.stroke();
    }

    for(const p of State.paths){
      ctx.beginPath();
      ctx.moveTo(p.start.x,p.start.y);
      ctx.lineTo(p.end.x,p.end.y);
      ctx.lineWidth=p.size;
      ctx.lineCap='round';
      ctx.strokeStyle=p.color;
      ctx.stroke();
    }

    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.font='16px Arial';

    for(const t of State.text_elements){
      ctx.fillStyle=t.color;
      ctx.fillText(t.content,t.x,t.y);
    }

    drawTurtle();
    ctx.restore();
    requestAnimationFrame(draw);
  }

  function drawTurtle(){
    ctx.save();
    ctx.translate(State.x,State.y);
    ctx.rotate((90-State.heading)*Math.PI/180);
    ctx.beginPath();
    ctx.moveTo(0,-12);
    ctx.lineTo(10,8);
    ctx.lineTo(-10,8);
    ctx.closePath();
    ctx.fillStyle=State.pen_color;
    ctx.fill();
    ctx.restore();
  }

  requestAnimationFrame(draw); updateStatus();

  function detectMobile(){
    const ua=navigator.userAgent||navigator.vendor||window.opera;
    const isMobile=/android|iphone|ipad|mobile/i.test(ua);
    State.is_mobile=isMobile;
    if(isMobile) $('mobileHint').style.display='block';
  }
  detectMobile();

  window.__TURTLE_STATE=State;
  window.__TURTLE_reset=()=>{State.paths=[];State.polygons=[];State.text_elements=[];State.x=400;State.y=300;State.heading=0;State.bg_color='black';updateStatus();};
})();
</script>

